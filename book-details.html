<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Details - OceanBooks</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
    body {
      background: radial-gradient(circle at top, #0a0a0a 0%, #000 100%);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Navbar */
    .navbar {
      background: rgba(15, 15, 15, 0.7);
      backdrop-filter: blur(10px);
      padding: 1.2rem 5%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }
    .nav-brand { font-size:1.6rem; font-weight:bold; color:#00e0ff; text-decoration:none; letter-spacing:1px; }
    .back-btn {
      background: linear-gradient(90deg,#00e0ff,#00ffaa);
      color:#000; padding:0.6rem 1.3rem; border-radius:8px;
      text-decoration:none; font-weight:600; display:flex; align-items:center; gap:0.4rem;
      transition:all 0.3s ease; box-shadow:0 0 10px rgba(0,255,255,0.3);
    }
    .back-btn:hover { transform:translateY(-2px); box-shadow:0 0 20px rgba(0,255,255,0.6); }

    /* Main Container */
    .container { max-width:950px; margin:120px auto 80px; padding:0 1rem; }

    .book-thumbnail {
      width:100%; aspect-ratio:3/4; background:linear-gradient(145deg,#1a1a1a,#0e0e0e);
      display:flex; align-items:center; justify-content:center;
      border-radius:15px; overflow:hidden; margin-bottom:2.5rem;
      box-shadow:0 20px 40px rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.05);
    }
    .book-thumbnail img { width:100%; height:100%; object-fit:contain; transition:transform 0.6s ease; }
    .book-thumbnail:hover img { transform:scale(1.03); }

    .book-details {
      background: rgba(25,25,25,0.9); border-radius:15px;
      padding:2rem; box-shadow:0 15px 40px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.05);
      animation:fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

    .book-category { text-transform:uppercase; color:#00e0ff; font-size:0.9rem; margin-bottom:0.5rem; letter-spacing:1px; }
    .book-title { font-size:2.2rem; font-weight:bold; margin-bottom:0.5rem; }
    .book-author { font-size:1.1rem; color:#aaa; margin-bottom:1.5rem; }
    .book-description {
      line-height:1.7; color:#ccc; margin-bottom:1.8rem;
      background:#141414; padding:1.2rem; border-radius:10px;
      border-left:4px solid #00ffaa; box-shadow:inset 0 0 15px rgba(0,255,170,0.1);
    }

    .meta {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
      gap:1rem; color:#aaa; margin-bottom:2.5rem;
    }
    .meta-item { background:#111; padding:0.8rem 1rem; border-radius:10px; border:1px solid #222; }
    .meta-label { font-size:0.8rem; color:#777; text-transform:uppercase; letter-spacing:0.5px; }
    .meta-value { font-weight:600; color:#fff; }

    /* Download section */
    .download-section { text-align:center; position:relative; }
    .download-btn {
      display:inline-block; background:linear-gradient(90deg,#00ffaa,#00e0ff);
      color:#000; font-weight:700; padding:1rem 2.5rem; border-radius:12px;
      text-decoration:none; letter-spacing:0.5px;
      box-shadow:0 0 20px rgba(0,255,255,0.4);
      transition:all 0.3s ease;
    }
    .download-btn:hover { transform:translateY(-3px); box-shadow:0 0 30px rgba(0,255,255,0.7); }

    .progress-container {
      width:100%; background:#111; border-radius:10px; overflow:hidden;
      margin-top:1.5rem; height:14px; display:none;
    }
    .progress-bar {
      width:0%; height:100%;
      background:linear-gradient(90deg,#00ffaa,#00e0ff);
      box-shadow:0 0 10px rgba(0,255,255,0.5);
      transition:width 0.1s linear;
    }
    .progress-text {
      margin-top:1rem; color:#999; font-size:0.95rem; font-weight:500;
    }

    /* Footer */
    .footer {
      background: rgba(15,15,15,0.8); backdrop-filter: blur(10px);
      padding: 3rem 2rem 2rem; text-align: center;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .footer-links { display:flex; justify-content:center; gap:2rem; flex-wrap:wrap; margin-bottom:1rem; }
    .footer-links a { color:#aaa; text-decoration:none; transition:color 0.3s ease; }
    .footer-links a:hover { color:#00e0ff; }
    .copyright { color:#666; font-size:0.9rem; margin-top:0.8rem; }

    @media (max-width:600px) {
      .book-title { font-size:1.7rem; }
      .book-details { padding:1.5rem; }
      .download-btn { width:100%; }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <a href="main.html" class="nav-brand">OceanBooks</a>
    <a href="main.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Books</a>
  </nav>

  <!-- Book Content -->
  <div class="container" id="book-content">
    <div class="book-thumbnail"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
    <div class="book-details"><p>Loading book details...</p></div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-links">
      <a href="main.html">BOOKS</a>
      <a href="index.html#about">About</a>
      <a href="index.html#contact">Contact</a>
      <a href="admin/admin.html">Admin</a>
      <a href="index.html#privacy">Privacy</a>
      <a href="index.html#terms">Terms</a>
    </div>
    <div class="copyright">&copy; 2025 OceanBooks. All rights reserved.</div>
  </footer>

  <script>
    async function fetchBookDetails() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) return;

      try {
        const res = await fetch('https://oceanbooks.onrender.com/api/books');
        const books = await res.json();
        const book = books.find(b => b.id == id);
        if (!book) {
          document.getElementById('book-content').innerHTML = '<p>Book not found.</p>';
          return;
        }

        document.getElementById('book-content').innerHTML = `
          <div class="book-thumbnail">
            ${book.thumbnail_path ? 
              `<img src="${book.thumbnail_path}" alt="${book.title}" onerror="this.style.display='none'; this.parentNode.innerHTML='<i class=\\'fas fa-book\\'></i>';">` : 
              `<i class="fas fa-book fa-3x"></i>`}
          </div>

          <div class="book-details">
            <div class="book-category">${book.category}</div>
            <div class="book-title">${book.title}</div>
            <div class="book-author">by ${book.author}</div>
            <div class="book-description">
              ${book.description || "No description available for this book."}
            </div>
            <div class="meta">
              <div class="meta-item"><div class="meta-label">File Size</div><div class="meta-value">${book.file_size}</div></div>
              <div class="meta-item"><div class="meta-label">Downloads</div><div class="meta-value">${book.downloads}</div></div>
              <div class="meta-item"><div class="meta-label">Uploaded</div><div class="meta-value">${new Date(book.upload_date).toLocaleDateString()}</div></div>
              <div class="meta-item"><div class="meta-label">File Name</div><div class="meta-value">${book.file_name}</div></div>
            </div>
            <div class="download-section">
              <button class="download-btn" id="download-btn"><i class="fas fa-download"></i> Download Book</button>
              <div class="progress-container" id="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
              </div>
              <div class="progress-text" id="progress-text"></div>
            </div>
          </div>
        `;

        document.getElementById('download-btn').addEventListener('click', (e) => {
          e.preventDefault();
          startRealDownload(book.id, book.file_name);
        });

      } catch (err) {
        document.getElementById('book-content').innerHTML = `<p>Error loading details. ${err}</p>`;
      }
    }

    async function startRealDownload(bookId, fileName) {
      const btn = document.getElementById('download-btn');
      const progressContainer = document.getElementById('progress-container');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');

      btn.style.display = 'none';
      progressContainer.style.display = 'block';
      progressText.textContent = 'Starting download...';

      try {
        const response = await fetch(`https://oceanbooks.onrender.com/api/books/${bookId}/download`);
        if (!response.ok) throw new Error('Failed to fetch file.');

        const reader = response.body.getReader();
        const contentLength = +response.headers.get('Content-Length') || 1;
        let receivedLength = 0;
        let chunks = [];

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          chunks.push(value);
          receivedLength += value.length;
          const percent = Math.round((receivedLength / contentLength) * 100);
          progressBar.style.width = percent + '%';
          progressText.textContent = `Downloading... ${percent}%`;
        }

        progressBar.style.width = '100%';
        progressText.textContent = 'Finalizing...';

        const blob = new Blob(chunks);
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();

        window.URL.revokeObjectURL(url);
        progressText.innerHTML = '<span style="color:#00ffaa;">Download Complete 🎉</span>';

        setTimeout(() => {
          progressContainer.style.display = 'none';
          progressBar.style.width = '0%';
          progressText.textContent = '';
          btn.style.display = 'inline-block';
        }, 2500);

      } catch (error) {
        progressText.textContent = 'Download failed: ' + error.message;
        progressBar.style.background = 'red';
        setTimeout(() => {
          progressContainer.style.display = 'none';
          progressBar.style.width = '0%';
          progressText.textContent = '';
          btn.style.display = 'inline-block';
          progressBar.style.background = 'linear-gradient(90deg,#00ffaa,#00e0ff)';
        }, 3000);
      }
    }

    fetchBookDetails();
  </script>
</body>
</html>